generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum Role {
  ADMIN
  GESTIONNAIRE
  LECTURE
}

enum AssetStatus {
  EN_STOCK
  PRETE
  HS
  REPARATION
}

enum LoanStatus {
  OPEN
  CLOSED
}

model User {
  id           String   @id @default(cuid())
  email        String   @unique
  passwordHash String
  role         Role     @default(GESTIONNAIRE)
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  loansCreated     Loan[]     @relation("LoanCreatedBy")
  loansDeleted     Loan[]     @relation("LoanDeletedBy")
  managedEmployees Employee[] @relation("EmployeeManager")
  auditLogs        AuditLog[]

  @@index([email])
  @@index([role])
  @@index([role, createdAt])
}

model Employee {
  id           String                    @id @default(cuid())
  firstName    String
  lastName     String
  email        String?                   @unique
  dept         String?
  managerId    String?
  searchVector Unsupported("tsvector")?
  createdAt    DateTime                  @default(now())
  updatedAt    DateTime                  @updatedAt

  manager   User?    @relation("EmployeeManager", fields: [managerId], references: [id], onDelete: SetNull)
  loans     Loan[]

  @@index([lastName, firstName])
  @@index([email])
  @@index([dept])
  @@index([managerId])
  @@index([managerId, dept])
}

model EquipmentType {
  id        String   @id @default(cuid())
  name      String   @unique
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model AssetModel {
  id           String                    @id @default(cuid())
  type         String
  brand        String
  modelName    String
  searchVector Unsupported("tsvector")?
  createdAt    DateTime                  @default(now())
  updatedAt    DateTime                  @updatedAt

  items      AssetItem[]
  stockItems StockItem[]

  @@unique([type, brand, modelName])
  @@index([type])
  @@index([brand])
  @@index([type, brand])
}

model AssetItem {
  id           String                    @id @default(cuid())
  assetModelId String
  assetTag     String?                   @unique
  serial       String?                   @unique
  status       AssetStatus               @default(EN_STOCK)
  notes        String?
  searchVector Unsupported("tsvector")?
  createdAt    DateTime                  @default(now())
  updatedAt    DateTime                  @updatedAt

  assetModel   AssetModel  @relation(fields: [assetModelId], references: [id], onDelete: Cascade)
  loanLines    LoanLine[]

  @@index([assetModelId])
  @@index([status])
  @@index([assetModelId, status])
  @@index([status, createdAt])
}

model StockItem {
  id           String     @id @default(cuid())
  assetModelId String
  quantity     Int        @default(0)
  loaned       Int        @default(0)
  notes        String?
  createdAt    DateTime   @default(now())
  updatedAt    DateTime   @updatedAt

  assetModel AssetModel @relation(fields: [assetModelId], references: [id], onDelete: Cascade)
  loanLines  LoanLine[]

  @@index([assetModelId])
  @@index([quantity])
}

model Loan {
  id                  String     @id @default(cuid())
  employeeId          String
  status              LoanStatus @default(OPEN)
  createdById         String
  openedAt            DateTime   @default(now())
  closedAt            DateTime?

  pickupSignatureUrl  String?
  returnSignatureUrl  String?
  pickupSignedAt      DateTime?
  returnSignedAt      DateTime?

  deletedAt           DateTime?
  deletedById         String?

  createdAt           DateTime   @default(now())
  updatedAt           DateTime   @updatedAt

  employee            Employee   @relation(fields: [employeeId], references: [id], onDelete: Restrict)
  createdBy           User       @relation("LoanCreatedBy", fields: [createdById], references: [id], onDelete: Restrict)
  deletedBy           User?      @relation("LoanDeletedBy", fields: [deletedById], references: [id], onDelete: SetNull)
  lines               LoanLine[]

  @@index([employeeId])
  @@index([status])
  @@index([deletedAt])
  @@index([openedAt])
  @@index([closedAt])
  @@index([createdById])
  @@index([employeeId, status])
  @@index([openedAt, status])
  @@index([createdById, status])
  @@index([createdById, openedAt])
}

model LoanLine {
  id          String   @id @default(cuid())
  loanId      String
  assetItemId String?
  stockItemId String?
  quantity    Int      @default(1)
  addedAt     DateTime @default(now())

  loan        Loan       @relation(fields: [loanId], references: [id], onDelete: Cascade)
  assetItem   AssetItem? @relation(fields: [assetItemId], references: [id], onDelete: SetNull)
  stockItem   StockItem? @relation(fields: [stockItemId], references: [id], onDelete: SetNull)

  @@index([loanId])
  @@index([assetItemId])
  @@index([stockItemId])
  @@index([loanId, assetItemId])
  @@index([loanId, stockItemId])
}

model AuditLog {
  id        String   @id @default(cuid())
  userId    String
  action    String
  tableName String
  recordId  String
  oldValues Json?
  newValues Json?
  ipAddress String?
  userAgent String?
  createdAt DateTime @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([tableName, recordId])
  @@index([userId])
  @@index([userId, createdAt])
  @@index([createdAt])
  @@index([action])
  @@index([tableName, action])
}
