generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum Role {
  ADMIN
  GESTIONNAIRE
  LECTURE
}

enum AssetStatus {
  EN_STOCK
  PRETE
  HS
  REPARATION
}

enum LoanStatus {
  OPEN
  CLOSED
}

model User {
  id           String   @id @default(cuid())
  email        String   @unique
  passwordHash String
  role         Role     @default(GESTIONNAIRE)
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  loansCreated Loan[]   @relation("LoanCreatedBy")
  loansDeleted Loan[]   @relation("LoanDeletedBy")
}

model Employee {
  id        String   @id @default(cuid())
  firstName String
  lastName  String
  email     String?  @unique
  dept      String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  loans     Loan[]
}

model EquipmentType {
  id        String   @id @default(cuid())
  name      String   @unique
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model AssetModel {
  id        String   @id @default(cuid())
  type      String
  brand     String
  modelName String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  items      AssetItem[]
  stockItems StockItem[]
}

model AssetItem {
  id           String      @id @default(cuid())
  assetModelId String
  assetTag     String?     @unique
  serial       String?     @unique
  status       AssetStatus @default(EN_STOCK)
  notes        String?
  createdAt    DateTime    @default(now())
  updatedAt    DateTime    @updatedAt

  assetModel   AssetModel  @relation(fields: [assetModelId], references: [id])
  loanLines    LoanLine[]
}

model StockItem {
  id           String     @id @default(cuid())
  assetModelId String
  quantity     Int        @default(0)
  loaned       Int        @default(0)
  notes        String?
  createdAt    DateTime   @default(now())
  updatedAt    DateTime   @updatedAt

  assetModel AssetModel @relation(fields: [assetModelId], references: [id])
  loanLines  LoanLine[]
}

model Loan {
  id                  String     @id @default(cuid())
  employeeId          String
  status              LoanStatus @default(OPEN)
  createdById         String
  openedAt            DateTime   @default(now())
  closedAt            DateTime?

  pickupSignatureUrl  String?
  returnSignatureUrl  String?
  pickupSignedAt      DateTime?
  returnSignedAt      DateTime?

  deletedAt           DateTime?
  deletedById         String?

  employee            Employee   @relation(fields: [employeeId], references: [id])
  createdBy           User       @relation("LoanCreatedBy", fields: [createdById], references: [id])
  deletedBy           User?      @relation("LoanDeletedBy", fields: [deletedById], references: [id])
  lines               LoanLine[]
}

model LoanLine {
  id          String   @id @default(cuid())
  loanId      String
  assetItemId String?
  stockItemId String?
  quantity    Int      @default(1)
  addedAt     DateTime @default(now())

  loan        Loan       @relation(fields: [loanId], references: [id])
  assetItem   AssetItem? @relation(fields: [assetItemId], references: [id])
  stockItem   StockItem? @relation(fields: [stockItemId], references: [id])
}
