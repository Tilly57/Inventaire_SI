# Release v0.6.21 - 2026-01-05

**Type:** Bugfix - Critical
**Branch:** release/0.6.21

## ğŸ¯ Objectif

Correction critique du problÃ¨me de date "CrÃ©Ã© le" vide dans les dÃ©tails de prÃªt, causÃ© par un client Prisma non synchronisÃ© avec le schÃ©ma aprÃ¨s migration.

## ğŸ› Corrections de bugs

### Fix date "CrÃ©Ã© le" vide dans dÃ©tails du prÃªt (Critique)

**ProblÃ¨me:**
Lors de la crÃ©ation d'un nouveau prÃªt, le champ "CrÃ©Ã© le" restait vide dans la page de dÃ©tails, mÃªme si la valeur existait en base de donnÃ©es.

**SymptÃ´mes:**
- Interface: Champ "CrÃ©Ã© le" affichait vide (ligne vide)
- Console navigateur: `loan.createdAt: undefined`
- Console backend: `loan.createdAt: undefined`
- Base de donnÃ©es: Colonne `createdAt` contenait bien les valeurs

**Cause racine:**
Le client Prisma n'avait pas Ã©tÃ© rÃ©gÃ©nÃ©rÃ© aprÃ¨s la migration `20251230094017_add_loan_timestamps` qui a ajoutÃ© les champs `createdAt` et `updatedAt` au modÃ¨le Loan.

**Impact:**
```
prisma migrate deploy    âœ… Migration appliquÃ©e en BDD
                         âŒ Client Prisma non rÃ©gÃ©nÃ©rÃ©
                         â†’ Types TypeScript obsolÃ¨tes
                         â†’ Champs non accessibles dans le code
```

**Solution appliquÃ©e:**
```bash
# RÃ©gÃ©nÃ©ration du client Prisma
npx prisma generate
```

Le client Prisma est un code gÃ©nÃ©rÃ© Ã  partir du schÃ©ma. AprÃ¨s chaque modification du schÃ©ma ou migration, il DOIT Ãªtre rÃ©gÃ©nÃ©rÃ© pour synchroniser:
- Les types TypeScript
- Les requÃªtes disponibles
- Les champs accessibles

**Fichier modifiÃ©:** `apps/web/src/components/loans/LoanFormDialog.tsx`

AmÃ©lioration supplÃ©mentaire pour garantir la disponibilitÃ© immÃ©diate des donnÃ©es:
```typescript
const onSubmit = async (data: CreateLoanFormData) => {
  const loan = await createLoan.mutateAsync(data)

  // Mise en cache immÃ©diate AVANT navigation
  queryClient.setQueryData(['loans', loan.id], loan)

  // Navigation vers dÃ©tails
  onSuccess(loan.id)
}
```

**Avant v0.6.21:**
```
CrÃ©er prÃªt â†’ API retourne loan â†’ Navigation
                                    â†“
                            useLoan charge (fetch API)
                                    â†“
                            createdAt: undefined âŒ
```

**AprÃ¨s v0.6.21:**
```
CrÃ©er prÃªt â†’ API retourne loan â†’ Cache mis Ã  jour â†’ Navigation
                                                          â†“
                                                  useLoan lit cache
                                                          â†“
                                                  createdAt: "2026-01-05..." âœ…
```

## ğŸ“‹ Documentation - ProcÃ©dure Ã  suivre

### AprÃ¨s toute migration Prisma

**Obligatoire:**
```bash
# 1. Appliquer la migration
npx prisma migrate dev           # En dÃ©veloppement
npx prisma migrate deploy        # En production

# 2. TOUJOURS rÃ©gÃ©nÃ©rer le client
npx prisma generate              # âš ï¸ NE PAS OUBLIER
```

### Checklist dÃ©ploiement

**En production (serveur):**
```bash
# 1. Pull du code
git pull origin main

# 2. Installer dÃ©pendances si package.json modifiÃ©
npm install

# 3. Appliquer migrations
cd apps/api
npx prisma migrate deploy

# 4. RÃ©gÃ©nÃ©rer client Prisma
npx prisma generate              # âš ï¸ CRITIQUE

# 5. RedÃ©marrer services
pm2 restart all
```

## ğŸ”§ Fichiers ModifiÃ©s

- `apps/web/src/components/loans/LoanFormDialog.tsx` - Mise en cache immÃ©diate

## ğŸ“Š Impact

**Avant v0.6.21:**
- âŒ Date "CrÃ©Ã© le" vide dans interface
- âŒ Confusion utilisateur (pourquoi vide?)
- âŒ DonnÃ©es en BDD non accessibles dans le code

**AprÃ¨s v0.6.21:**
- âœ… Date "CrÃ©Ã© le" affichÃ©e immÃ©diatement aprÃ¨s crÃ©ation
- âœ… Toutes les dates de crÃ©ation visibles (prÃªts existants et nouveaux)
- âœ… Client Prisma synchronisÃ© avec schÃ©ma
- âœ… AmÃ©lioration rÃ©activitÃ© (cache immÃ©diat)

## ğŸ§ª Tests EffectuÃ©s

**ScÃ©nario de test:**
1. CrÃ©er un nouveau prÃªt avec un employÃ©
2. Page de dÃ©tails s'ouvre automatiquement
3. VÃ©rifier que "CrÃ©Ã© le" affiche la date du jour
4. Console navigateur: `loan.createdAt` doit Ãªtre une string ISO
5. Console backend: `loan.createdAt` doit Ãªtre un objet Date
6. Prisma Studio: Colonne `createdAt` doit avoir une valeur

**RÃ©sultats:**
- âœ… Date affichÃ©e correctement
- âœ… `createdAt` prÃ©sent dans logs frontend et backend
- âœ… Valeur en BDD correcte
- âœ… PrÃªts existants affichent aussi leur date de crÃ©ation

## ğŸ“ Commits

- `[hash]` fix(loans): Ensure loan cache is set immediately before navigation to display createdAt

## ğŸ”— Contexte

Cette release corrige un problÃ¨me critique introduit par la migration `add_loan_timestamps`. Le problÃ¨me n'Ã©tait pas dans la migration elle-mÃªme (qui fonctionnait correctement) mais dans l'oubli de rÃ©gÃ©nÃ©rer le client Prisma.

**LeÃ§on apprise:** Toujours exÃ©cuter `npx prisma generate` aprÃ¨s une migration, mÃªme en dÃ©veloppement.

## âš ï¸ Note pour les dÃ©ploiements futurs

**Scripts de dÃ©ploiement Ã  mettre Ã  jour:**

Ajouter dans `scripts/deploy-production.sh` aprÃ¨s les migrations:
```bash
# After migrations
print_info "Regenerating Prisma client..."
cd apps/api
npx prisma generate
print_success "Prisma client regenerated"
```

---

**TestÃ© par:** Claude Code + Tests utilisateur
**Type:** Bugfix critique
**Urgence:** Haute (fonctionnalitÃ© cassÃ©e)
**Breaking changes:** Non
