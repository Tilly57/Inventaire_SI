# Release v0.6.24 - 2026-01-05

**Type:** Hotfix - Docker Build
**Branch:** release/0.6.24

## ğŸ¯ Objectif

Correction finale du build Docker de l'application web qui Ã©chouait Ã  cause d'un flag npm manquant pour gÃ©rer les conflits de peer dependencies.

## ğŸ› Corrections de bugs

### Docker Build Error - Web App (Critique)

**ProblÃ¨me:** Le build Docker de l'application web Ã©chouait avec:
```
ERROR: failed to build: failed to solve:
process "/bin/sh -c npm ci" did not complete successfully: exit code: 1
```

**Cause racine:**
IncohÃ©rence entre le Dockerfile web et le workflow CI/CD concernant la gestion des peer dependencies.

**Dans le Dockerfile web (ligne 10):**
```dockerfile
RUN npm ci
```

**Dans le workflow CI (.github/workflows/ci.yml ligne 86):**
```bash
npm ci --legacy-peer-deps
```

**Pourquoi --legacy-peer-deps est nÃ©cessaire:**

L'application web utilise React 19 et plusieurs packages @radix-ui qui n'ont pas encore Ã©tÃ© mis Ã  jour pour dÃ©clarer officiellement React 19 comme peer dependency compatible. Sans le flag `--legacy-peer-deps`, npm ci Ã©choue avec des erreurs de conflits de peer dependencies.

**Exemple de conflit:**
```
npm ERR! Could not resolve dependency:
npm ERR! peer react@"^18.0.0" from @radix-ui/react-dialog@1.1.15
npm ERR! node_modules/@radix-ui/react-dialog
npm ERR!   @radix-ui/react-dialog@"^1.1.15" from the root project
```

**Solution:**
```dockerfile
# Avant (ligne 10)
RUN npm ci

# AprÃ¨s (ligne 10)
RUN npm ci --legacy-peer-deps
```

## ğŸ“‹ Contexte des dÃ©pendances React 19

### Packages concernÃ©s:
- **react**: ^19.2.0
- **react-dom**: ^19.2.0
- **@radix-ui/*** : Divers packages encore sur peer dependency react@^18

### Pourquoi utiliser --legacy-peer-deps est acceptable ici:

1. **CompatibilitÃ© testÃ©e:** L'application fonctionne correctement avec React 19 en local et en CI
2. **Packages stables:** Les composants Radix UI fonctionnent sans problÃ¨me avec React 19
3. **Solution temporaire:** En attendant que Radix UI mette Ã  jour leurs peer dependencies
4. **Alternative Ã  --force:** Plus sÃ»r que `--force` car ne modifie pas le lock file

## ğŸ”§ Fichiers ModifiÃ©s

- `apps/web/Dockerfile` (ligne 10) : Ajout de `--legacy-peer-deps` au `npm ci`

## ğŸ“Š Impact

**Avant v0.6.24:**
- âŒ CI/CD docker-build job Ã©chouait pour l'image web
- âŒ Impossible de construire l'image Docker web
- âŒ Pipeline CI/CD bloquÃ©
- âœ… Build API rÃ©ussissait (fix v0.6.23)

**AprÃ¨s v0.6.24:**
- âœ… Docker build web rÃ©ussit
- âœ… Docker build API rÃ©ussit
- âœ… CI/CD pipeline entiÃ¨rement opÃ©rationnel
- âœ… DÃ©ploiement possible

## ğŸ§ª Test Docker local

Pour tester les builds localement:

```bash
# Test API
cd apps/api
docker build -t inventaire-api-test .

# Test Web
cd apps/web
docker build -t inventaire-web-test .

# Test avec docker-compose
cd ../..
docker-compose build
docker-compose up
```

## ğŸ“ Commits

- `[hash]` fix(docker): Add --legacy-peer-deps flag to web Dockerfile npm ci

## ğŸ”— Contexte

Cette release complÃ¨te la sÃ©rie de fixes Docker:

**Chronologie complÃ¨te des fixes Docker:**
- **v0.6.18:** Fix `npm ci --only=production=false` â†’ `npm ci` (web)
- **v0.6.22:** Fix `npm ci --only=production` â†’ `npm ci` (api)
- **v0.6.23:** Fix ordre COPY - ajouter schema Prisma avant npm ci (api)
- **v0.6.24:** Fix `npm ci` â†’ `npm ci --legacy-peer-deps` (web) âœ…

## ğŸ’¡ LeÃ§ons apprises

### 1. CohÃ©rence entre environnements

Toujours vÃ©rifier que les flags npm sont identiques entre:
- Dockerfile de production
- Workflow CI/CD
- Scripts de dÃ©veloppement local

### 2. Gestion des peer dependencies

Avec npm 7+, les peer dependencies sont strictement validÃ©es. Options:
- `--legacy-peer-deps`: Ignore les conflits (comme npm 6)
- `--force`: Force l'installation (modifie package-lock.json)
- Mettre Ã  jour les packages pour rÃ©soudre les conflits

### 3. React version upgrades

Lors de l'upgrade vers une nouvelle version majeure de React:
1. VÃ©rifier que tous les packages UI sont compatibles
2. Tester en local avec les flags npm appropriÃ©s
3. S'assurer que Dockerfile, CI, et dev utilisent les mÃªmes flags
4. Documenter les incompatibilitÃ©s temporaires

## ğŸ” DÃ©tection future

Pour Ã©viter ces problÃ¨mes Ã  l'avenir:

1. **Tests Docker locaux systÃ©matiques** avant chaque release
2. **Alignement des commandes npm** entre tous les environnements
3. **Documentation des flags spÃ©ciaux** (--legacy-peer-deps, --force, etc.)

---

**TestÃ© par:** Claude Code
**Type:** Hotfix critique Docker
**Urgence:** Haute (bloque CI/CD et dÃ©ploiements)
