# Release Notes - Version 0.6.11

**Date**: 2025-12-30

## ğŸ› Correction Critique

### RÃ©solution dÃ©finitive des erreurs 429 Too Many Requests

Cette release corrige les boucles infinies de requÃªtes causÃ©es par des invalidations en cascade dans les hooks React Query.

**ProblÃ¨me rÃ©solu :**
- âœ… Plus d'erreurs 429 Too Many Requests lors de modifications
- âœ… Performance optimale des requÃªtes API
- âœ… Mises Ã  jour UI automatiques sans rafraÃ®chissement manuel
- âœ… Navigation fluide dans toute l'application

## ğŸ”§ Corrections Techniques

### ProblÃ¨me identifiÃ©

Tous les hooks de mutation utilisaient un pattern redondant :
```typescript
await queryClient.invalidateQueries({ queryKey: ['assetItems'] })
await queryClient.refetchQueries({ queryKey: ['assetItems'] })
```

**ConsÃ©quences :**
- Double appel crÃ©ait des cascades infinies de requÃªtes
- React Query refetchait automatiquement aprÃ¨s invalidation
- Le refetch manuel dÃ©clenchait une nouvelle invalidation
- Boucle infinie â†’ Erreurs 429 Too Many Requests

### Solution appliquÃ©e

**Pattern corrigÃ© :**
```typescript
// Invalidate only - React Query refetch automatiquement les queries actives
await queryClient.invalidateQueries({ queryKey: ['assetItems'] })
```

**Hooks modifiÃ©s :**

1. **useUpdateAssetItem** (`apps/web/src/lib/hooks/useAssetItems.ts`)
   - RetirÃ© `refetchQueries` redondant
   - RetirÃ© options `refetchType: 'active'` et `type: 'active'`
   - SimplifiÃ© Ã  une seule invalidation

2. **useCreateAssetItem** (`apps/web/src/lib/hooks/useAssetItems.ts`)
   - RetirÃ© `refetchQueries` redondant
   - SimplifiÃ© Ã  une seule invalidation

3. **useCreateAssetModel** (`apps/web/src/lib/hooks/useAssetModels.ts`)
   - RetirÃ© `refetchQueries` redondant
   - Garde invalidation `assetItems` pour afficher nouveaux Ã©quipements

4. **useUpdateAssetModel** (`apps/web/src/lib/hooks/useAssetModels.ts`)
   - Garde invalidation conditionnelle intelligente :
     ```typescript
     if (variables.data.quantity && variables.data.quantity > 0) {
       await queryClient.invalidateQueries({ queryKey: ['assetItems'] })
     }
     ```
   - N'invalide `assetItems` que si une quantitÃ© est ajoutÃ©e

## ğŸ“‹ Comportement AmÃ©liorÃ©

### Avant (v0.6.10)
- âŒ Erreurs 429 lors de modification d'Ã©quipements
- âŒ Boucles infinies de requÃªtes
- âŒ Performance dÃ©gradÃ©e
- âŒ NÃ©cessitait parfois un rafraÃ®chissement manuel

### AprÃ¨s (v0.6.11)
- âœ… Aucune erreur 429
- âœ… Une seule requÃªte par modification
- âœ… Performance optimale
- âœ… Mises Ã  jour automatiques et instantanÃ©es
- âœ… Navigation fluide

## ğŸ¯ Cas d'Usage TestÃ©s

**Modification d'Ã©quipement :**
1. Modifier un Ã©quipement (tag, statut, notes)
2. Sauvegarder
3. âœ… Liste mise Ã  jour automatiquement
4. âœ… Aucune erreur 429

**Ajout de quantitÃ© Ã  un modÃ¨le :**
1. Modifier un modÃ¨le et ajouter une quantitÃ©
2. Sauvegarder
3. âœ… ModÃ¨le mis Ã  jour automatiquement
4. âœ… Nouveaux Ã©quipements apparaissent automatiquement
5. âœ… Aucune erreur 429

**CrÃ©ation d'Ã©quipement :**
1. CrÃ©er un nouvel Ã©quipement
2. Sauvegarder
3. âœ… AjoutÃ© Ã  la liste automatiquement
4. âœ… Aucune erreur 429

**CrÃ©ation de modÃ¨le avec quantitÃ© :**
1. CrÃ©er un modÃ¨le avec quantitÃ© initiale
2. Sauvegarder
3. âœ… ModÃ¨le ajoutÃ© automatiquement
4. âœ… Ã‰quipements crÃ©Ã©s automatiquement
5. âœ… Aucune erreur 429

## ğŸ“ Fichiers ModifiÃ©s

**Frontend (2 fichiers) :**
- `apps/web/src/lib/hooks/useAssetItems.ts`
- `apps/web/src/lib/hooks/useAssetModels.ts`

## ğŸ§  LeÃ§ons Apprises

**Best Practice React Query :**
- `invalidateQueries` suffit pour dÃ©clencher un refetch automatique
- Pas besoin de `refetchQueries` aprÃ¨s `invalidateQueries`
- Les options `refetchType` et `type` peuvent causer des comportements inattendus
- PrivilÃ©gier la simplicitÃ© : une seule mÃ©thode d'invalidation

**Pattern recommandÃ© :**
```typescript
onSuccess: async () => {
  // Simple invalidation - React Query fait le reste
  await queryClient.invalidateQueries({ queryKey: ['resource'] })
}
```

**Anti-pattern Ã  Ã©viter :**
```typescript
onSuccess: async () => {
  // âŒ Double invalidation redondante
  await queryClient.invalidateQueries({ queryKey: ['resource'] })
  await queryClient.refetchQueries({ queryKey: ['resource'] })
}
```

## âœ… Tests

- [x] Modification d'Ã©quipement sans erreur 429
- [x] CrÃ©ation d'Ã©quipement sans erreur 429
- [x] Modification de modÃ¨le sans erreur 429
- [x] Modification de modÃ¨le avec quantitÃ© sans erreur 429
- [x] CrÃ©ation de modÃ¨le avec quantitÃ© sans erreur 429
- [x] Dashboard fonctionne correctement
- [x] Navigation fluide dans toute l'application
- [x] Mises Ã  jour UI automatiques

## ğŸ”„ Migration

Aucune migration de base de donnÃ©es requise pour cette version.

## ğŸ“¦ DÃ©ploiement

```bash
# Reconstruire les conteneurs
docker-compose down
docker-compose up -d --build

# VÃ©rifier les logs
docker-compose logs web --tail=20
```

---

**Commit principal :** `42c38d9` - fix: Correction des boucles infinies de requÃªtes React Query
