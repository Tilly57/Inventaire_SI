# Release v0.6.23 - 2026-01-05

**Type:** Hotfix - Docker Build
**Branch:** release/0.6.23

## ğŸ¯ Objectif

Correction finale de l'erreur Docker build dans le CI/CD pipeline qui persistait malgrÃ© le fix de la v0.6.22.

## ğŸ› Corrections de bugs

### Docker Build Error - Prisma Schema Missing (Critique)

**ProblÃ¨me:** MalgrÃ© le fix de la v0.6.22 (changement vers `npm ci`), le build Docker Ã©chouait toujours avec:
```
ERROR: failed to build: failed to solve:
process "/bin/sh -c npm ci" did not complete successfully: exit code: 1
```

**Cause racine:**
Le package `@prisma/client` exÃ©cute automatiquement un script postinstall lors de `npm ci` qui:
1. Cherche le fichier `prisma/schema.prisma`
2. Tente de gÃ©nÃ©rer le client Prisma
3. Si le schema est absent â†’ exit code 1

**Ordre problÃ©matique dans Dockerfile:**
```dockerfile
COPY package*.json ./
RUN npm ci              # âŒ @prisma/client postinstall cherche schema.prisma
                        # âŒ Fichier pas encore copiÃ© â†’ erreur
COPY . .                # Schema copiÃ© trop tard
```

**Solution:**
```dockerfile
COPY package*.json ./
COPY prisma ./prisma/   # âœ… Copier le schema AVANT npm ci
RUN npm ci              # âœ… Postinstall peut maintenant accÃ©der au schema
COPY . .
RUN npx prisma generate # GÃ©nÃ©ration explicite supplÃ©mentaire (sÃ©curitÃ©)
```

## ğŸ“‹ Ordre correct des opÃ©rations Docker

### Principe: Copier uniquement ce qui est nÃ©cessaire Ã  chaque Ã©tape

**Ã‰tape 1: DÃ©pendances Node.js**
```dockerfile
COPY package*.json ./
```
Copie uniquement les fichiers de dÃ©pendances pour optimiser le cache Docker.

**Ã‰tape 2: Schema Prisma (NOUVEAU)**
```dockerfile
COPY prisma ./prisma/
```
Copie le schema Prisma AVANT l'installation car:
- `@prisma/client` postinstall en a besoin
- Permet la gÃ©nÃ©ration automatique du client
- Ã‰vite les erreurs lors de npm ci

**Ã‰tape 3: Installation**
```dockerfile
RUN npm ci
```
Installation avec toutes les dÃ©pendances (y compris devDependencies pour Prisma).

**Ã‰tape 4: Code application**
```dockerfile
COPY . .
```
Copie tout le reste du code application.

**Ã‰tape 5: GÃ©nÃ©ration explicite**
```dockerfile
RUN npx prisma generate
```
RÃ©gÃ©nÃ©ration explicite du client pour garantir synchronisation avec le schema.

## ğŸ”§ Fichiers ModifiÃ©s

- `apps/api/Dockerfile` (ligne 9) : Ajout de `COPY prisma ./prisma/` avant `npm ci`

## ğŸ“Š Impact

**Avant v0.6.23:**
- âŒ CI/CD docker-build Ã©chouait (exit code 1)
- âŒ Impossible de construire l'image API Docker
- âŒ DÃ©ploiement bloquÃ©

**AprÃ¨s v0.6.23:**
- âœ… Docker build API rÃ©ussit
- âœ… CI/CD pipeline opÃ©rationnel
- âœ… DÃ©ploiement possible

## ğŸ§ª Test local Docker

Pour tester le build localement:
```bash
cd apps/api
docker build -t inventaire-api-test .

# Si succÃ¨s, tester le run:
docker run -p 3001:3001 \
  -e DATABASE_URL="postgresql://..." \
  -e JWT_ACCESS_SECRET="test" \
  -e JWT_REFRESH_SECRET="test" \
  inventaire-api-test
```

## ğŸ“ Commits

- `09a21a3` fix(docker): Copy Prisma schema before npm ci

## ğŸ”— Contexte

Cette release complÃ¨te le fix de la v0.6.22. Le problÃ¨me n'Ã©tait pas seulement l'installation de toutes les dÃ©pendances, mais aussi l'ordre des opÃ©rations COPY dans le Dockerfile.

**Chronologie des fixes Docker:**
- **v0.6.18:** Fix `npm ci --only=production=false` â†’ `npm ci` (web)
- **v0.6.22:** Fix `npm ci --only=production` â†’ `npm ci` (api)
- **v0.6.23:** Fix ordre COPY - ajouter schema Prisma avant npm ci (api) âœ…

## ğŸ’¡ LeÃ§ons apprises

### 1. Scripts postinstall npm
Les packages peuvent exÃ©cuter des scripts lors de l'installation qui nÃ©cessitent des fichiers externes. Toujours vÃ©rifier les dÃ©pendances de ces scripts.

### 2. Ordre Docker COPY
L'ordre des instructions COPY est crucial:
- Copier seulement ce qui est nÃ©cessaire Ã  chaque Ã©tape
- Respecter les dÃ©pendances entre fichiers
- Optimiser le cache Docker (fichiers rarement modifiÃ©s en premier)

### 3. Prisma dans Docker
Prisma nÃ©cessite une attention particuliÃ¨re en Docker:
- Schema doit Ãªtre disponible avant npm install
- DevDependencies nÃ©cessaires en production (prisma CLI)
- GÃ©nÃ©ration explicite recommandÃ©e aprÃ¨s COPY du code

---

**TestÃ© par:** Claude Code
**Type:** Hotfix critique Docker
**Urgence:** Haute (bloque CI/CD et dÃ©ploiements)
