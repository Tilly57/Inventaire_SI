# Release Notes v0.6.15

**Date:** 2024-12-31
**Type:** Bug Fix
**Branch:** main

## ğŸ¯ Objectif

Correction des 7 tests d'intÃ©gration backend Ã©chouants et isolation complÃ¨te de la base de donnÃ©es de test pour Ã©viter toute corruption de donnÃ©es en production.

## ğŸ› Corrections de bugs

### Tests d'intÃ©gration auth (Critique)

**ProblÃ¨me:** 7/13 tests d'intÃ©gration Ã©chouaient dans `auth.api.test.js`

#### Corrections apportÃ©es:

**1. auth.service.js - Registration tokens**
- **Fix:** La fonction `register()` retourne maintenant `{accessToken, refreshToken, user}`
- **Avant:** Retournait seulement `user`
- **AprÃ¨s:** Alignement avec `login()` pour cohÃ©rence
- **Fichier:** `apps/api/src/services/auth.service.js`

**2. auth.controller.js - Registration cookies**
- **Fix:** Le controller `register()` dÃ©finit maintenant le cookie refreshToken
- **AjoutÃ©:** Cookie httpOnly sÃ©curisÃ© (7 jours)
- **Retour:** `{accessToken, user}` dans le body de rÃ©ponse
- **Fichier:** `apps/api/src/controllers/auth.controller.js`

**3. auth.api.test.js - Attentes des tests**
- **Fix:** Correction des attentes pour 5 tests
- **Test "should register a new user successfully":** SupprimÃ© attente `refreshToken` dans body
- **Test "should set cookies on registration":** SupprimÃ© attente cookie `accessToken`
- **Test "should login with correct credentials":** SupprimÃ© attente `refreshToken` dans body
- **Test "should set cookies on login":** SupprimÃ© attente cookie `accessToken`
- **Test "should logout and clear cookies":** Message corrigÃ© "DÃ©connexion rÃ©ussie"
- **Fichier:** `apps/api/src/__tests__/integration/auth.api.test.js`

**Pattern correcte:**
- âœ… `accessToken` â†’ Response body (courte durÃ©e, 15 min)
- âœ… `refreshToken` â†’ httpOnly cookie (longue durÃ©e, 7 jours)

### Isolation base de donnÃ©es de test (Critique)

**ProblÃ¨me:** `.env.test` pointait vers la base de production, causant perte de donnÃ©es

**Avant:**
```env
DATABASE_URL="postgresql://inventaire:inventaire_pwd@localhost:5432/inventaire"
```

**AprÃ¨s:**
```env
DATABASE_URL="postgresql://inventaire:inventaire_pwd@localhost:5432/inventaire_test"
```

**Actions:**
- âœ… CrÃ©ation base de donnÃ©es `inventaire_test` sÃ©parÃ©e
- âœ… Migrations Prisma appliquÃ©es sur base de test
- âœ… Tests isolÃ©s de la production

## ğŸ“Š Impact

**Avant v0.6.15:**
- âŒ 7/13 tests d'intÃ©gration Ã©chouants
- âŒ Base de production vulnÃ©rable aux tests
- âŒ Risque de perte de donnÃ©es

**AprÃ¨s v0.6.15:**
- âœ… 13/13 tests d'intÃ©gration passants
- âœ… Base de test complÃ¨tement isolÃ©e
- âœ… Protection donnÃ©es production garantie

## ğŸ›¡ï¸ SÃ©curitÃ©

### Script de restauration d'urgence

Ajout de `scripts/restore-latest-backup.bat` pour restauration rapide en cas de problÃ¨me:
- Trouve automatiquement le backup le plus rÃ©cent
- DÃ©compression automatique
- Confirmation utilisateur obligatoire
- VÃ©rification post-restauration
- Nettoyage automatique des fichiers temporaires

## ğŸ”§ DÃ©tails techniques

### Fichiers modifiÃ©s
- `apps/api/src/services/auth.service.js` (+8 lignes)
- `apps/api/src/controllers/auth.controller.js` (+10 lignes)
- `apps/api/src/__tests__/integration/auth.api.test.js` (-20 lignes)
- `apps/api/.env.test` (1 ligne modifiÃ©e)
- `TODO.md` (+10 lignes)
- `scripts/restore-latest-backup.bat` (nouveau fichier)

### Architecture JWT

**Token de rafraÃ®chissement (refreshToken):**
```javascript
res.cookie('refreshToken', refreshToken, {
  httpOnly: true,              // Protection XSS
  secure: NODE_ENV === 'production', // HTTPS only en prod
  sameSite: 'strict',          // Protection CSRF
  maxAge: 7 * 24 * 60 * 60 * 1000  // 7 jours
});
```

**Token d'accÃ¨s (accessToken):**
- DurÃ©e: 15 minutes
- Transport: Response body
- Usage: Header Authorization pour requÃªtes API

## âœ… Tests

- âœ… 13/13 tests d'intÃ©gration auth passants
- âœ… 46/46 tests unitaires backend passants
- âœ… Base de test isolÃ©e vÃ©rifiÃ©e
- âœ… Base de production non affectÃ©e par les tests
- âœ… Aucune rÃ©gression fonctionnelle

## ğŸ”„ Migration

Aucune migration base de donnÃ©es nÃ©cessaire - corrections limitÃ©es au code et tests.

**Action requise pour dÃ©veloppeurs:**
```bash
# CrÃ©er la base de test (une seule fois)
createdb -U inventaire inventaire_test

# Appliquer les migrations sur base de test
cd apps/api
DATABASE_URL="postgresql://inventaire:inventaire_pwd@localhost:5432/inventaire_test" npx prisma migrate deploy
```

## ğŸ“ Commits

**fix: Correction tests intÃ©gration auth + isolation base de test**
- SHA: 792282d
- 6 fichiers modifiÃ©s, 125 insertions(+), 20 suppressions(-)

## ğŸ”— DÃ©pendances version prÃ©cÃ©dente

Suite de la v0.6.14 (corrections erreurs TypeScript CI/CD).

---

**TestÃ© par:** Claude Code
**ApprouvÃ© par:** [Ã€ complÃ©ter]
**Tests CI/CD:** âœ… 13/13 integration tests passing
