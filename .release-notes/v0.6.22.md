# Release v0.6.22 - 2026-01-05

**Type:** Hotfix - CI/CD
**Branch:** release/0.6.22

## ğŸ¯ Objectif

Correction urgente de l'erreur Docker build dans le CI/CD pipeline qui empÃªchait la construction de l'image API.

## ğŸ› Corrections de bugs

### Docker Build Error - API (Critique)

**ProblÃ¨me:** Le CI/CD Ã©chouait lors du build Docker de l'application API avec l'erreur :
```
ERROR: failed to build: failed to solve:
process "/bin/sh -c npm ci" did not complete successfully: exit code: 1
```

**Cause:** Dockerfile API utilisait `npm ci --only=production` mais ensuite tentait d'exÃ©cuter `npx prisma generate`. Le package `prisma` Ã©tant une devDependency, il n'Ã©tait pas installÃ© en mode `--only=production`.

**Contexte:**
```dockerfile
# Avant (ligne 9)
RUN npm ci --only=production

# Puis plus tard (ligne 15)
RUN npx prisma generate  # âŒ Ã‰chec: prisma non trouvÃ©
```

**Solution:**
```dockerfile
# AprÃ¨s (ligne 9)
RUN npm ci

# Puis plus tard (ligne 15)
RUN npx prisma generate  # âœ… Fonctionne: prisma installÃ©
```

**Explication:**
En production avec Docker, nous avons BESOIN des devDependencies pour:
1. **prisma generate**: NÃ©cessite les packages `@prisma/client` + `prisma`
2. **prisma migrate deploy**: NÃ©cessite le CLI `prisma`
3. Gestion de la base de donnÃ©es au runtime

Contrairement Ã  une application Node.js classique oÃ¹ on peut se passer des devDependencies en production, Prisma requiert ses outils en production pour:
- GÃ©nÃ©rer le client lors du build
- ExÃ©cuter les migrations au dÃ©marrage du conteneur

## ğŸ”§ Fichiers ModifiÃ©s

- `apps/api/Dockerfile` (ligne 9) : Changement de `npm ci --only=production` vers `npm ci`

## ğŸ“Š Impact

**Avant v0.6.22:**
- âŒ CI/CD docker-build job Ã©chouait systÃ©matiquement
- âŒ Impossible de construire l'image Docker API
- âŒ Pipeline CI bloquÃ©
- âŒ DÃ©ploiement production impossible

**AprÃ¨s v0.6.22:**
- âœ… Docker build API fonctionne correctement
- âœ… CI/CD pipeline complet opÃ©rationnel
- âœ… Images Docker construites avec succÃ¨s
- âœ… DÃ©ploiement production possible

## ğŸ“‹ ConsidÃ©rations

### Taille de l'image Docker

**Question:** L'installation de toutes les dÃ©pendances n'augmente-t-elle pas la taille de l'image?

**RÃ©ponse:** Oui, mais c'est nÃ©cessaire pour Prisma. Alternatives pour optimiser:

1. **Multi-stage build** (recommandÃ© futur):
```dockerfile
# Stage 1: Builder avec toutes les dÃ©pendances
FROM node:20-alpine AS builder
RUN npm ci
RUN npx prisma generate
COPY . .

# Stage 2: Production avec dÃ©pendances minimales
FROM node:20-alpine
COPY --from=builder /app/node_modules/@prisma ./node_modules/@prisma
COPY --from=builder /app/node_modules/prisma ./node_modules/prisma
# etc.
```

2. **Installation sÃ©lective**:
   - Garder uniquement `prisma` et `@prisma/client` en dependencies
   - DÃ©placer autres devDependencies en optionalDependencies

Pour l'instant, la solution simple (`npm ci`) est suffisante et garantit que tout fonctionne.

## ğŸ“ Commits

- `88f99d9` fix(docker): Install all dependencies for Prisma client generation

## ğŸ”— Contexte

Ce fix fait suite au dÃ©ploiement v0.6.21 qui a introduit des amÃ©liorations pour Prisma. L'erreur n'Ã©tait pas visible auparavant car le Dockerfile n'avait pas Ã©tÃ© testÃ© rÃ©cemment avec les nouvelles dÃ©pendances Prisma.

**LeÃ§on apprise:** Toujours tester les builds Docker localement avant de pousser vers CI/CD.

## ğŸ§ª Test Docker local

Pour tester le build localement avant de pousser:
```bash
# Build API
cd apps/api
docker build -t inventaire-api .

# Build Web
cd apps/web
docker build -t inventaire-web .

# Tester avec docker-compose
cd ../..
docker-compose build
docker-compose up
```

---

**TestÃ© par:** Claude Code
**Type:** Hotfix critique CI/CD
**Urgence:** Haute (bloque dÃ©ploiements)
