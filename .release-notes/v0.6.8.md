# Release v0.6.8

**Release Date:** 2025-12-30

## üéØ Highlights

- Stack de monitoring complet (Loki + Prometheus + Grafana)
- Gestion s√©curis√©e des secrets avec Docker secrets
- Logging structur√© avec Winston (21 fichiers migr√©s)
- Health checks Kubernetes-compatible
- M√©triques HTTP et business instrument√©es

## üîê S√©curit√©

### Gestion S√©curis√©e des Secrets
- **Script generate-secrets.sh**: G√©n√©ration automatique de secrets forts
  * JWT Access Secret (64 caract√®res base64)
  * JWT Refresh Secret (64 caract√®res base64)
  * Database Password (32 caract√®res alphanum√©riques)
  * Permissions 600 pour protection fichiers
- **Docker Secrets**: Configuration compl√®te dans docker-compose.yml
  * Secrets lus depuis `/run/secrets/` au lieu de variables d'environnement
  * Variables `_FILE` pour charger depuis fichiers
- **Validation au d√©marrage**: Rejet automatique des secrets par d√©faut
  * Liste noire: change_me_*, supersecretkey, secret, changeme, default
  * Application refuse de d√©marrer avec secrets non s√©curis√©s
- **Protection Git**: .gitignore mis √† jour (secrets/, .env.production)

### Rate Limiting (d√©j√† impl√©ment√©, v√©rifi√©)
- express-rate-limit actif avec 4 limiters
- Protection brute-force sur login (5 tentatives/15min)
- General limiter (100 req/15min)
- Mutation limiter (30 mutations/15min)
- Upload limiter (10 uploads/heure)

## üìä Monitoring & Observabilit√©

### Logging Structur√© avec Winston
- **21 fichiers migr√©s**: Tous les console.log/warn/error remplac√©s
  * 8 fichiers core (index, services, middleware, utils)
  * 8 fichiers seeds
  * 2 fichiers tests
  * 3 fichiers config
- **Logger centralis√©**: apps/api/src/config/logger.js
  * Logs JSON structur√©s pour production
  * Logs color√©s console pour d√©veloppement
  * Rotation automatique (5MB max, 5 fichiers)
  * Contexte et m√©tadonn√©es dans tous les logs
- **Helper createContextLogger**: Logging avec contexte service

### Stack de Monitoring Complet

**Loki (Port 3100):**
- Agr√©gation et interrogation des logs
- Collecte logs JSON depuis Winston via Promtail
- Configuration: monitoring/promtail-config.yml

**Prometheus (Port 9090):**
- Collecte m√©triques toutes les 10 secondes
- Endpoint: http://localhost:3001/api/metrics
- Configuration: monitoring/prometheus.yml
- 15+ m√©triques instrument√©es

**Grafana (Port 3000):**
- Dashboards pr√©-configur√©s
- Datasources auto-provisionn√©es (Prometheus + Loki)
- Login: admin/admin (√† changer)

### M√©triques Instrument√©es

**HTTP (automatiques):**
- `http_requests_total`: Total requ√™tes
- `http_request_duration_seconds`: Latence (histogram)
- `http_response_size_bytes`: Taille r√©ponses
- `http_requests_in_progress`: Requ√™tes actives

**Business (pr√™tes √† utiliser):**
- `loans_total{status}`: Pr√™ts OPEN/CLOSED
- `loans_created_total`: Pr√™ts cr√©√©s
- `loans_closed_total`: Pr√™ts ferm√©s
- `employees_total`: Total employ√©s
- `assets_total{status}`: √âquipements par statut

**Node.js (par d√©faut via prom-client):**
- CPU, m√©moire, event loop, heap
- 20+ m√©triques process et runtime

### Dashboards Grafana

**API Dashboard (4 panels):**
- Taux de requ√™tes/s (timeseries)
- Latence p95 (gauge)
- Taux d'erreurs 5xx (timeseries)
- Requ√™tes en cours (gauge)

**Business Dashboard (5 panels):**
- Total employ√©s (gauge)
- Pr√™ts actifs (gauge)
- Total √©quipements (gauge)
- Activit√© pr√™ts (timeseries)
- R√©partition √©quipements (piechart)

### Health Checks Kubernetes-Compatible

**4 endpoints cr√©√©s:**
- `/api/health`: Health check simple (alias readiness)
- `/api/health/liveness`: Serveur vivant (processus actif)
- `/api/health/readiness`: Pr√™t √† recevoir trafic (v√©rifie DB)
- `/api/health/startup`: Initialisation compl√®te (migrations, tables)

**Docker healthcheck:**
- V√©rifie `/api/health/readiness` toutes les 30s
- 3 retries avant de marquer unhealthy
- Start period: 40s

## üì¶ Nouveaux Fichiers (16 fichiers)

### S√©curit√©
1. `scripts/generate-secrets.sh` - Script g√©n√©ration secrets

### Logging
2. `apps/api/src/config/logger.js` - Logger Winston centralis√©

### Monitoring
3. `apps/api/src/config/metrics.js` - D√©finition m√©triques Prometheus
4. `apps/api/src/middleware/metricsMiddleware.js` - Collecte m√©triques HTTP
5. `apps/api/src/routes/metrics.routes.js` - Endpoint /api/metrics
6. `apps/api/src/routes/health.routes.js` - Endpoints health checks

### Configuration Monitoring
7. `monitoring/prometheus.yml` - Config Prometheus
8. `monitoring/promtail-config.yml` - Config Promtail
9. `monitoring/grafana/provisioning/datasources/datasources.yml` - Datasources
10. `monitoring/grafana/provisioning/dashboards/dashboards.yml` - Provisioning dashboards
11. `monitoring/grafana/dashboards/api-dashboard.json` - Dashboard API
12. `monitoring/grafana/dashboards/business-dashboard.json` - Dashboard Business
13. `monitoring/README.md` - Documentation monitoring stack

## üîß Fichiers Modifi√©s (25 fichiers)

### Configuration
- `docker-compose.yml`: 4 services monitoring + healthcheck API + volumes logs
- `.gitignore`: Exclusion secrets/, .env.production
- `apps/api/package.json`: Ajout winston, prom-client

### Backend Core
- `apps/api/src/index.js`: Validation secrets + chargement depuis Docker secrets
- `apps/api/src/app.js`: Middleware m√©triques + route health
- `apps/api/src/routes/index.js`: Routes health checks

### Logging Migration (21 fichiers)
- 8 fichiers core: index, services, middleware, utils, config
- 8 fichiers seeds
- 2 fichiers tests
- Tous console.log/warn/error ‚Üí logger.info/warn/error

### Documentation
- `TODO.md`: 4 sections compl√©t√©es (Secrets, Rate Limiting, Logging, Monitoring)

## üöÄ Utilisation

### D√©marrer le monitoring
```bash
docker-compose up -d
```

### Acc√©der aux UIs
- Grafana: http://localhost:3000 (admin/admin)
- Prometheus: http://localhost:9090
- Loki: http://localhost:3100
- M√©triques brutes: http://localhost:3001/api/metrics

### G√©n√©rer les secrets (premi√®re fois)
```bash
chmod +x scripts/generate-secrets.sh
./scripts/generate-secrets.sh
docker-compose up -d --force-recreate
```

## üìà Impact

### S√©curit√©
- √âlimination des secrets hardcod√©s
- Validation stricte au d√©marrage
- Protection contre secrets faibles
- Conformit√© 12-factor app

### Observabilit√©
- Monitoring temps r√©el de l'API
- D√©tection probl√®mes avant impact utilisateur
- Logs structur√©s pour d√©bogage rapide
- M√©triques business pour insights

### DevOps
- Health checks pour orchestration (Kubernetes ready)
- Rotation logs automatique
- Dashboards pr√™ts pour production
- Stack monitoring cl√© en main

## üéØ Effort Total

- S√©curit√© - Secrets Management: 4h
- Rate Limiting: 2h (v√©rification)
- Logging Structur√©: 4h
- Monitoring Stack: 16h
- Health Checks: 2h
- **Total: 28h de t√¢ches critiques**

## All Commits

- feat(security): gestion s√©curis√©e des secrets avec Docker secrets
- feat(monitoring): logging structur√© avec Winston (21 fichiers)
- feat(monitoring): stack complet Loki + Prometheus + Grafana + health checks
